# 2. Container CVE remediation

Date: 2025-02-13

## Status

Accepted

## Context

There is a stakeholder request for MintMaker to inform the users if any container updates fix known vulnerabilities. These pull requests should be appropriately marked and should be created at a higher frequency - ignoring general container updates schedules. This functionality enables the users to quickly integrate new vulnerability fixes and expedite the release process.

## Decision

Upstream Renovate already has a similar feature, `osvVulnerabilityAlerts`, which gathers the vulnerabilities from OSV. Since OSV doesn't publish vulnerability data for containers, a custom solution had to be implemented. 

Red Hat publishes advisories that describe which images are affected by the found vulnerabilities. This data cannot be used in a straightforward way, so let's describe the evaluation process of a vulnerability to a container image. The advisories contain the publication dates and a list of container images (among other artifacts) affected by the vulnerability. Since images are only uniquely identified by their digest, the list is non-exhaustive and only contains the newest image affected by a vulnerability in a given repo. To figure out if any random image is affected, its age relative to the publication of the advisory must be examined. In other words, images older than the advisory are affected; images newer than the advisory have fixed the vulnerability. In other ecosystems this can be accomplished by comparing versions of the packages. In the container ecosystem, the closest analogue are tags. However, tags don't have a unified semantic meaning, and floating tags can change its underlying image over time. This means that it's impossible to determine if an image is affected by a vulnerability by comparing its tags. However, each image metadata contains the information of when an image was built, and advisories contain their publication date. With this information, we can claim that images older than an advisory are affected by the vulnerability, and images newer have fixed it. So, if Renovate suggests an image bump pull request, if the old image is older and the new image is newer than a vulnerability that affects its repo, we can claim that the PR fixes a vulnerability.

To accommodate this functionality, the images must be specified via their digest. With tags only, it may be impossible to determine vulnerability fixes. For example, if floating tag is used, Renovate cannot suggest an update since its underlying digest could have changed silently.

As mentioned previously, Renovate has a feature called `osvVulnerabilityAlerts`. It gets vulnerability information from the database which it downloads from Github during its runtime. The database is compiled from the OSV data twice a day, converted to a Renovate-friendly format and released as a Github release. This ensures that it remains up-to-date. The project responsible for releasing and loading the DB is called osv-offline and is one of Renovate's dependencies. To implement the new functionality, we need to extend the database with the container and RPM vulnerability data published by Red Hat. This is accomplished by a script in the MintMaker repo, which downloads the latest advisories, converts the data to the OSV format and compiles them to a new database file. It also downloads and extracts the upstream osv-offline database. Our downstream fork of osv-offline is extended to be able to read and search through the new data. The database in question is created by the MintMaker team as a workaround solution, it isn't an official OSV database published by Red Hat.

This section describes how the vulnerability data becomes available to Renovate PipelineRuns created by MintMaker. A new container image has been created, which is rebuilt periodically and contains the upstream OSV data as well as our RPM and container data. The aforementioned script is called inside the Dockerfile to download the latest data, and the resulting image is pushed to Quay. During the Pipeline's run the image is loaded as the first step, and the DB data is copied to a shared volume with the second step. The second step runs Renovate which makes use of the now available data. There are technical reasons why this approach was chosen instead of persistent volume shared by all PipeLineRuns, or downloading the DB in each PipelineRun. Firstly, due to a limitation of Konflux cluster's storage classes, each pod mounting a volume must be provisioned on the same node as the persistent volume. This means that all Renovate pods would have to be scheduled on the same node, creating a bottleneck. Secondly, keeping the data on a container image can utilize Openshift's caching and there's no danger of exceeding any API/rate limits - this is why this approach is better than downloading the DB for each run from an external website.

To support the new functionality, changes to Renovate's code were necessary. A new module that works analogously to `osvVulnerabilityAlerts` was created. This module supports the custom container creation time comparison logic but otherwise contains the same workflow as `osvVulnerabilityAlerts`. If it recognizes that a proposed PR fixes a vulnerability, it creates a package rule that ensures that the vulnerability information is included and that the PR can be created outside of the normal schedule.


## Consequences

The downstream Renovate implementation forces us to maintain this code ourselves and creates more toil for keeping up with upstream. The approach analogous to `osvVulnerabilityAlerts` should ensure that the solution will always be compatible with Renovate even if there are some underlying implementation changes.

We have to maintain a new repository that periodically puts the OSV DB to a container image. We also have to maintain our downstream fork of osv-offline.

The approach to compare image creation dates instead of SEMVER versions is unusual and may lead to issues in the future.
